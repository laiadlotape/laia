# LAIA Sysctl Hardening Configuration
# Based on: Arch Linux Security Wiki, madaidans-insecurities Linux Hardening Guide,
#           Debian Hardening Wiki, CIS Benchmark recommendations
#
# Apply with: sysctl -p /etc/sysctl.d/99-laia-hardening.conf
# Or copy to /etc/sysctl.d/99-laia-hardening.conf and reboot
#
# ============================================================
# KERNEL SELF-PROTECTION
# ============================================================

# Restrict kernel pointer exposure in /proc/kallsyms and other interfaces.
# Kernel pointers are useful for crafting exploits — hiding them raises the bar.
# 2 = hide from all users including root (most secure); 1 = hide from non-root only
kernel.kptr_restrict = 2

# Restrict access to the kernel log (dmesg).
# The kernel log can leak sensitive memory addresses and kernel internals.
# 1 = require CAP_SYSLOG to read dmesg
kernel.dmesg_restrict = 1

# Suppress kernel log output on the console during boot.
# Prevents information leaks visible to screen recorders or nearby observers.
kernel.printk = 3 3 3 3

# Disable kexec — prevents loading a new kernel at runtime.
# An attacker with root access could use kexec to replace the running kernel
# with a malicious one, bypassing all other security controls.
kernel.kexec_load_disabled = 1

# Restrict ptrace scope — ptrace allows one process to inspect/modify another.
# Unrestricted ptrace is a major attack vector for privilege escalation.
# 1 = only allow ptrace on child processes (most compatible secure setting)
# 2 = only allow ptrace with CAP_SYS_PTRACE (stricter)
# 3 = disable ptrace completely (breaks debuggers/gdb)
kernel.yama.ptrace_scope = 1

# Restrict SysRq key functionality.
# SysRq can trigger dangerous kernel actions remotely via /proc/sysrq-trigger.
# 4 = only allow the Secure Attention Key (SAK)
kernel.sysrq = 4

# Restrict eBPF to privileged users.
# eBPF (extended Berkeley Packet Filter) has been the source of many kernel
# exploits. Restricting it to CAP_BPF reduces the attack surface significantly.
kernel.unprivileged_bpf_disabled = 1

# Enable JIT hardening for eBPF (constant blinding).
# Prevents JIT spray attacks where attacker fills kernel memory with shellcode.
net.core.bpf_jit_harden = 2

# Restrict TTY line discipline autoloading.
# Prevents unprivileged attackers from loading vulnerable TTY line disciplines
# via TIOCSETD ioctl, which has been exploited in several privilege escalation CVEs.
dev.tty.ldisc_autoload = 0

# Restrict userfaultfd() to privileged users.
# userfaultfd() is frequently abused to exploit use-after-free vulnerabilities
# by slowing down kernel execution to create race condition windows.
vm.unprivileged_userfaultfd = 0

# Restrict performance events to privileged users.
# perf_event_open() can leak sensitive kernel data.
# 3 = disallow raw tracepoints for unprivileged users
kernel.perf_event_paranoid = 3

# ============================================================
# MEMORY PROTECTION
# ============================================================

# Enable full Address Space Layout Randomization (ASLR).
# ASLR randomizes where the kernel places code, stack, heap, and libraries in
# memory, making it much harder for attackers to predict memory addresses in exploits.
# 0 = disabled, 1 = partial, 2 = full (including heap) — always use 2
kernel.randomize_va_space = 2

# Restrict mmap to prevent low-memory mapping attacks.
# Prevents mapping of memory at very low addresses, which can be exploited
# in combination with NULL pointer dereference vulnerabilities.
vm.mmap_min_addr = 65536

# ============================================================
# CORE DUMP PROTECTION
# ============================================================

# Disable core dumps for setuid programs.
# Setuid programs run with elevated privileges; their core dumps could contain
# sensitive data (passwords, keys) or be used to extract privileged memory.
# 0 = disabled (most secure), 1 = allow world-readable, 2 = allow root-readable
fs.suid_dumpable = 0

# ============================================================
# FILESYSTEM PROTECTION
# ============================================================

# Protect against symlink following attacks (TOCTOU exploits).
# Without this, an unprivileged user can create a symlink in a world-writable
# directory (like /tmp) pointing to a sensitive file, tricking privileged programs.
# Protected: only allow following symlinks owned by the same user as the directory.
fs.protected_symlinks = 1

# Protect against hardlink attacks.
# Without this, unprivileged users can create hardlinks to setuid binaries
# in world-writable directories, enabling various local privilege escalations.
# Protected: only allow creating hardlinks to files you own.
fs.protected_hardlinks = 1

# Protect FIFOs (named pipes) in world-writable sticky directories.
# Prevents named pipe hijacking attacks similar to symlink attacks.
fs.protected_fifos = 2

# Protect regular files in world-writable sticky directories.
# Prevents regular file creation attacks in directories like /tmp.
fs.protected_regular = 2

# ============================================================
# NETWORK — IPv4
# ============================================================

# Disable IP packet forwarding.
# This system is a desktop, not a router. Forwarding would allow the machine to
# act as a relay for network traffic — a potential security and privacy risk.
net.ipv4.ip_forward = 0

# Enable TCP SYN cookies to protect against SYN flood DoS attacks.
# A SYN flood exhausts connection state tables. SYN cookies allow the server
# to handle connections without allocating state until the handshake completes.
net.ipv4.tcp_syncookies = 1

# Protect against TIME_WAIT assassination (RFC 1337).
# Drops RST packets for sockets in TIME_WAIT state, preventing an attacker
# from injecting RST packets to terminate legitimate connections.
net.ipv4.tcp_rfc1337 = 1

# Enable reverse path (source) filtering on all interfaces.
# Validates that incoming packets arrive on the expected interface based on
# the routing table. Prevents IP spoofing attacks.
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Disable ICMP redirect acceptance.
# ICMP redirects can be used by an attacker to redirect your traffic through
# a malicious host (man-in-the-middle). Disable both accepting and sending.
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Disable source routing.
# Source routing allows the sender to specify the route packets take.
# This can be abused for man-in-the-middle attacks.
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Ignore bogus ICMP error responses.
# Reduces exposure to malformed ICMP attacks and prevents clock fingerprinting.
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Log packets with impossible source addresses.
# Helps detect IP spoofing attacks by logging obviously-forged packets
# (martian packets — addresses that shouldn't appear on public networks).
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Disable TCP SACK (Selective Acknowledgment).
# SACK has been exploited in several remote DoS vulnerabilities (e.g., SACK Panic).
# Disabling it eliminates this attack vector at the cost of some throughput on lossy networks.
net.ipv4.tcp_sack = 0
net.ipv4.tcp_dsack = 0
net.ipv4.tcp_fack = 0

# Disable TCP timestamps to prevent remote OS fingerprinting.
# TCP timestamps can reveal system uptime and allow fingerprinting of the OS.
# This is a privacy measure — it reduces information leakage.
net.ipv4.tcp_timestamps = 0

# ============================================================
# NETWORK — IPv6
# ============================================================

# Disable IPv6 forwarding.
net.ipv6.conf.all.forwarding = 0
net.ipv6.conf.default.forwarding = 0

# Disable IPv6 ICMP redirect acceptance.
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Disable IPv6 router advertisement acceptance.
# Malicious RA packets can be used to redirect IPv6 traffic through an
# attacker-controlled router, enabling man-in-the-middle attacks.
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

# Disable IPv6 source routing.
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# NOTE: To fully disable IPv6, add "ipv6.disable=1" to kernel boot parameters
# in /etc/default/grub (GRUB_CMDLINE_LINUX). The sysctl settings above minimize
# IPv6 attack surface without fully disabling it (which may break some applications).
