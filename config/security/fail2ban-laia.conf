# LAIA fail2ban configuration
# Protects against brute-force and automated attack tools
#
# fail2ban monitors log files and bans IPs that show malicious behavior
# (repeated failed logins, port scans, etc.) via iptables/ufw rules.
#
# Install: apt-get install fail2ban
# Deploy: cp this file /etc/fail2ban/jail.d/laia.conf
# Reload: systemctl restart fail2ban

[DEFAULT]
# Ban after 3 failed attempts — strict but reasonable for a hardened system
maxretry = 3

# Ban duration: 1 hour (3600 seconds) for most jails
# Balances security with usability (you can recover from accidental lockouts)
bantime = 3600

# Detection window: 10 minutes
# If 3 failures happen within 10 minutes, trigger a ban
findtime = 600

# Backend for reading log files (auto-detect is usually fine)
backend = auto

# Use UFW as the ban action (since we use UFW for our firewall)
banaction = ufw

# Notification email — configure only if sendmail/postfix is available
# destemail = admin@localhost
# sender = fail2ban@localhost
# action = %(action_mwl)s  # mail with whois lookup and log lines

# -----------------------------------------------------------------------
# SSH PROTECTION
# -----------------------------------------------------------------------

[sshd]
# Protect SSH from brute force login attempts
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
# Very strict: 3 attempts, 24-hour ban
# SSH is the highest-value target; attackers will try thousands of passwords
maxretry = 3
bantime = 86400

# -----------------------------------------------------------------------
# SSH DDoS PROTECTION
# -----------------------------------------------------------------------

[sshd-ddos]
# Protect against connection floods (DDoS-style attacks on SSH)
enabled = true
port = ssh
filter = sshd-ddos
logpath = /var/log/auth.log
# More lenient than brute force — 6 rapid connections = ban
maxretry = 6
bantime = 3600

# -----------------------------------------------------------------------
# OPENCLAW GATEWAY PROTECTION
# -----------------------------------------------------------------------

[openclaw]
# Protect the OpenClaw gateway from repeated auth failures
# (in case it's accidentally exposed or accessed via port forwarding)
enabled = true
port = 3101
filter = apache-auth
logpath = /var/log/openclaw/access.log
maxretry = 5
bantime = 3600

# -----------------------------------------------------------------------
# PAM AUTHENTICATION PROTECTION
# -----------------------------------------------------------------------

[pam-generic]
# Catch all PAM authentication failures (covers su, login, etc.)
enabled = true
filter = pam-generic
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

# -----------------------------------------------------------------------
# NOTES
# -----------------------------------------------------------------------
# To check ban status:   sudo fail2ban-client status sshd
# To unban an IP:        sudo fail2ban-client set sshd unbanip <ip>
# To test a filter:      fail2ban-regex /var/log/auth.log /etc/fail2ban/filter.d/sshd.conf
# To view logs:          journalctl -u fail2ban -f
