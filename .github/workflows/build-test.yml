name: Build & Test

on:
  push:
    branches: [ main, master, 'feat/**', 'fix/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run integration tests (Docker)
        run: |
          docker build -t laia-test -f tests/Dockerfile .
          docker run --rm laia-test bash tests/run-all.sh

      - name: Show test results
        if: always()
        run: echo "Tests completed"

  validate-configs:
    name: Validate Configuration Files
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get install -y python3 shellcheck

      - name: Validate JSON configs
        run: |
          for f in $(find . -name "*.json" -not -path "./.git/*"); do
            echo "Checking $f..."
            python3 -c "import json; json.load(open('$f'))" || exit 1
          done
          echo "✅ All JSON files valid"

      - name: Validate YAML configs
        run: |
          pip install pyyaml -q
          for f in $(find . -name "*.yaml" -o -name "*.yml" -not -path "./.git/*"); do
            echo "Checking $f..."
            python3 -c "import yaml; yaml.safe_load(open('$f'))" || exit 1
          done
          echo "✅ All YAML files valid"

      - name: ShellCheck (bash linting)
        run: |
          find . -name "*.sh" -not -path "./.git/*" | \
          xargs shellcheck --severity=warning || true
          echo "ShellCheck complete"

      - name: Security config check
        run: bash tests/test_openclaw_config.sh

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for committed secrets
        run: bash tests/test_no_secrets.sh

      - name: Verify security defaults
        run: |
          python3 -c "
          import json
          c = json.load(open('config/openclaw/openclaw-restricted.json'))
          bind = c.get('security', {}).get('bind', '')
          assert bind == '127.0.0.1', f'SECURITY FAIL: bind={bind}'
          ask = c.get('security', {}).get('exec', {}).get('ask', '')
          assert ask == 'always', f'SECURITY FAIL: exec.ask={ask}'
          elevated = c.get('security', {}).get('exec', {}).get('elevated', True)
          assert elevated == False, f'SECURITY FAIL: elevated={elevated}'
          print('✅ Security defaults verified: bind=127.0.0.1, ask=always, elevated=false')
          "

      - name: Check AppArmor profiles exist
        run: |
          test -f config/security/apparmor/ollama || { echo "Missing AppArmor profile: ollama"; exit 1; }
          test -f config/security/apparmor/openclaw || { echo "Missing AppArmor profile: openclaw"; exit 1; }
          echo "✅ AppArmor profiles present"

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check required docs exist
        run: bash tests/test_docs.sh

      - name: Check README badges
        run: |
          grep -q "Build Status" README.md || echo "⚠️  Missing CI badge in README"
          grep -q "License" README.md || echo "⚠️  Missing license badge in README"
          echo "Docs check complete"
